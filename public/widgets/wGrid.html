<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link id="them" rel="stylesheet">
</head>

<body>
    <script>
        let gendata = {};
        async function get() {
            try {
                const headers = {
                    'Accept': 'application/json'
                };
                const response = await fetch('https://api.grid.me.uk/api/current', {
                    method: 'GET',
                    headers: headers
                });
                const data = await response.json();
                console.log(data);
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function getLowCarbonPercent(data) {
            // Calculate total generation
            const totalGen = data['biomass'] + data['ccgt'] + data['coal'] + data['intelec'] + data['intew'] +
                data['intfr'] + data['intgrnl'] + data['intifa2'] + data['intirl'] + data['intned'] + data['intnem'] +
                data['intnsl'] + data['intvkl'] + data['npshyd'] + data['nuclear'] + data['ocgt'] + data['oil'] +
                data['other'] + data['ps'] + data['wind'] + data['solar'] + data['wind_embedded'];
            // Low carbon sources
            const lowCarbon = data['biomass'] + data['nuclear'] + data['npshyd'] + data['solar'] + data['wind'] +
                data['wind_embedded'];
            return Math.round((lowCarbon / totalGen) * 100);
        }

        function displayCO2Data(data) {
            const actual = data['co2'];
            const forecast = data['co2_forecast'];
            const index = data['co2_index'];
            if (actual !== undefined && actual !== null) {
                document.getElementById('actual').innerHTML = actual;
            } else {
                document.getElementById('actual').innerHTML = forecast;
            }
            document.getElementById('index').innerHTML = index;
        }

        function displayGenData(data) {
            let lcperc = getLowCarbonPercent(data);
            document.getElementById('lcpercent').innerHTML = lcperc;
        }
        async function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('theme');
            if (mode === "light") {
                document.getElementById('them').href = "./wGrid/light.css";
            } else if (mode === "dark") {
                document.getElementById('them').href = "./wGrid/style.css";
            } else {
                document.getElementById('them').href = "./wGrid/dumb.css";
                document.getElementById('header').innerHTML =
                "PLEASE SPECIFY A THEME (?theme=dark or ?theme=light)";
            }
            const data = await get();
            if (data) {
                displayCO2Data(data);
                displayGenData(data);
            }
        }
        document.addEventListener('DOMContentLoaded', main);
    </script>
    <br>
    <h3 id="header">UK Grid Carbon Intensity</h3>
    <h2><span id="actual"></span>gCOâ‚‚/kWh (<span id="index"></span>)</h2>
    <h2>Low Carbon: <span id="lcpercent"></span>%</h2>
    <i><a href="https://wilburwilliams.uk" target="_blank">Widget By Wilbur Williams</a></i>
</body>

</html>