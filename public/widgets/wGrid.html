<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link id="them" rel="stylesheet">
</head>

<body>
    <script>
        let gendata = {};

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function get() {
            const url = 'https://api.grid.me.uk/api/current';

            const maxRetries = 3;
            const timeoutPerRequest = 5000;
            const baseDelay = 500; 
            const maxDelay = 10000;

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                const controller = new AbortController();
                const signal = controller.signal;
                const timer = setTimeout(() => controller.abort(), timeoutPerRequest);

                try {
                    const response = await fetch(url, { method: 'GET', signal });
                    clearTimeout(timer);

                    const data = await response.json();

                    console.log('Fetched data', data);
                    return data;
                } catch (error) {
                    clearTimeout(timer);
                    const isLastAttempt = attempt === maxRetries;
                    console.warn(`Fetch attempt ${attempt + 1} failed:`, error);

                    // If aborted due to timeout or network/server error -> retry unless last attempt
                    if (isLastAttempt) {
                        console.error('All fetch retries failed:', error);
                        return;
                    }

                    // exponential backoff with small jitter
                    const backoff = Math.min(maxDelay, baseDelay * Math.pow(2, attempt));
                    const jitter = Math.floor(Math.random() * (backoff * 0.3));
                    await sleep(backoff + jitter);
                }
            }
        }

        function getLowCarbonPercent(data) {
            // Calculate total generation
            const totalGen = data['biomass'] + data['ccgt'] + data['coal'] + data['intelec'] + data['intew'] +
                data['intfr'] + data['intgrnl'] + data['intifa2'] + data['intirl'] + data['intned'] + data['intnem'] +
                data['intnsl'] + data['intvkl'] + data['npshyd'] + data['nuclear'] + data['ocgt'] + data['oil'] +
                data['other'] + data['ps'] + data['wind'] + data['solar'] + data['wind_embedded'];
            // Low carbon sources
            const lowCarbon = data['biomass'] + data['nuclear'] + data['npshyd'] + data['solar'] + data['wind'] +
                data['wind_embedded'];
            return Math.round((lowCarbon / totalGen) * 100);
        }

        function displayCO2Data(data) {
            const actual = data['co2'];
            const forecast = data['co2_forecast'];
            const index = data['co2_index'];
            if (actual !== undefined && actual !== null) {
                document.getElementById('actual').innerHTML = actual;
            } else {
                document.getElementById('actual').innerHTML = forecast;
            }
            document.getElementById('index').innerHTML = index;
        }

        function displayGenData(data) {
            let lcperc = getLowCarbonPercent(data);
            document.getElementById('lcpercent').innerHTML = lcperc;
        }
        async function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('theme');
            if (mode === "light") {
                document.getElementById('them').href = "./wGrid/light.css";
            } else if (mode === "dark") {
                document.getElementById('them').href = "./wGrid/style.css";
            } else {
                document.getElementById('them').href = "./wGrid/dumb.css";
                document.getElementById('header').innerHTML =
                "PLEASE SPECIFY A THEME (?theme=dark or ?theme=light)";
            }
            const data = await get();
            if (data) {
                displayCO2Data(data);
                displayGenData(data);
            }
        }
        document.addEventListener('DOMContentLoaded', main);
    </script>
    <br>
    <h3 id="header">UK Grid Carbon Intensity</h3>
    <h2><span id="actual"></span>gCOâ‚‚/kWh (<span id="index"></span>)</h2>
    <h2>Low Carbon: <span id="lcpercent"></span>%</h2>
    <i><a href="https://wilburwilliams.uk" target="_blank">Widget By Wilbur Williams</a></i>
</body>

</html>